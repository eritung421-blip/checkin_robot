<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>å‡ºå‹¤å°ç²¾éˆâœ¨ğŸ”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <style>
    :root { 
      --primary: #0daaba; 
      --primary-dark: #0a8e9b; 
      --wifi-btn: #0daaba;
      --wifi-btn-dark: #0daaba;
      --bg: #f4f7f6; 
      --white: #ffffff; 
      --text: #333333; 
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html, body {
      height: 100%; width: 100%; overflow: hidden; position: fixed;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg); margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
    }

    .container {
      width: 100%; height: 100%; max-width: 480px; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      padding: 15px; position: relative; z-index: 10;
    }

    .card {
      background: var(--white); 
      width: 100%; 
      padding: 24px 20px;
      border-radius: 24px; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
      display: flex; flex-direction: column; align-items: center;
      max-height: 95vh; overflow-y: auto;
    }
    .card::-webkit-scrollbar { display: none; }

    .header-group { display: flex; align-items: center; justify-content: center; margin-bottom: 12px; width: 100%; }
    .icon-box { font-size: 24px; margin-right: 8px; animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-4px);} }
    h2 { margin: 0; color: #2c3e50; font-size: 19px; font-weight: 800; }

    .input-group { width: 100%; margin-bottom: 12px; }
    
    label { font-size: 13px; font-weight: 700; color: var(--primary); display: block; margin-bottom: 6px; margin-left: 4px; }
    
    select, input { 
      display: block; width: 100%; height: 46px; 
      padding: 0 15px; border: 2px solid #f0f0f0; border-radius: 14px; 
      font-size: 16px; outline: none; background: #fafafa; 
      text-align: center; color: var(--text); -webkit-appearance: none;
    }
    
    select {
      text-align-last: center; 
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%230daaba%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; padding-right: 30px;
    }

    input[type="datetime-local"] { align-items: center; justify-content: center; display: flex; font-family: inherit; }

    /* åœ°åœ–æ¨£å¼ */
    #map {
      width: 100%; height: 250px; 
      border-radius: 18px; border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
      margin-bottom: 12px; z-index: 1; background: #f8f9fa; 
    }

    .user-pulse-marker {
        background-color: #ff5252; width: 16px; height: 16px;
        border-radius: 50%; border: 2px solid white;
        box-shadow: 0 0 10px rgba(0,0,0,0.2); position: relative;
    }
    .user-pulse-marker::after {
        content: ''; display: block; position: absolute;
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 32px; height: 32px; border-radius: 50%;
        background: rgba(255, 82, 82, 0.4); animation: pulse 1.5s infinite; z-index: -1;
    }
    @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }

    .info-text { font-size: 12px; color: #999; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 5px; height: 18px; }

    /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
    .btn {
      width: 100%; height: 50px; border: none; border-radius: 16px;
      font-size: 16px; font-weight: 700; color: var(--white);
      background: var(--primary); 
      box-shadow: 0 4px 15px rgba(13, 170, 186, 0.25);
      margin-bottom: 10px; cursor: pointer;
      display: flex; justify-content: center; align-items: center; line-height: 1; padding: 0;
      transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.97); background: var(--primary-dark); }
    .btn:disabled { background: #e0e0e0; color:#aaa; box-shadow: none; cursor: not-allowed; }
    
    /* ğŸŸ¢ æ–°å¢ï¼šé›™æ’æŒ‰éˆ•å®¹å™¨ */
    .btn-group {
      display: flex;
      width: 100%;
      gap: 10px; /* æŒ‰éˆ•é–“è· */
      margin-bottom: 10px;
    }
    /* è®“ç¾¤çµ„å…§çš„æŒ‰éˆ•å„ä½”ä¸€åŠ */
    .btn-group .btn {
      flex: 1;
      width: auto;
      margin-bottom: 0;
      font-size: 14px; /* å­—é«”ç¨å¾®ç¸®å°ä»¥é˜²æ›è¡Œ */
      padding: 0 4px;
    }

    /* é¡è‰²è®ŠåŒ– */
    .btn-wifi { background: var(--wifi-btn); box-shadow: 0 4px 15px rgba(134, 207, 185, 0.25); }
    .btn-wifi:active { background: var(--wifi-btn-dark); }

    .btn-mood { background: #ffc107; color: #5a4200; box-shadow: 0 4px 15px rgba(255, 193, 7, 0.25); }
    .btn-mood:active { background: #ffb300; }

    .footer-links { margin-top: 5px; }
    .link-btn { background: none; border: none; color: #b0b0b0; font-size: 13px; cursor: pointer; padding: 10px; }
    .link-btn:hover { color: var(--primary); }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); display: none; z-index: 9999; align-items: flex-start; justify-content: center; padding-top: 10vh; overflow-y: auto; }
    .modal { background: white; padding: 25px 20px; border-radius: 24px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: modalPop 0.3s ease-out; margin-bottom: 50px; }
    @keyframes modalPop { from { transform: scale(0.95) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

    .res-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 12px; }
    .res-msg { font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 20px; white-space: pre-wrap; }
    .close-btn { background: #f5f5f5; color: #888; box-shadow: none; height: 44px; margin: 0; }

    .mood-icon-wrapper { font-size: 64px; margin: 5px 0 15px; display: inline-block; }
    .score-list { background: #f8f9fa; border-radius: 12px; padding: 12px; margin-bottom: 15px; border: 1px solid #eee; max-height: 180px; overflow-y: auto; }
    .score-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #e0e0e0; font-size: 14px; }
    .confetti { position: fixed; width: 8px; height: 8px; background-color: #f00; animation: fall linear forwards; z-index: 100; opacity: 0; }
    @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 1; } }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <div class="header-group">
        <div class="icon-box">ğŸ”</div>
        <h2>å‡ºå‹¤å°ç²¾éˆ</h2>
      </div>

      <div class="input-group">
        <select id="manual-name">
          <option value="" disabled selected>è«‹é¸æ“‡æ‚¨çš„å§“å</option>
        </select>
      </div>

      <div id="map"></div>
      
      <div class="info-text">
        <span id="status">ğŸ“¡ æ­£åœ¨æœå°‹ GPS è¨Šè™Ÿ...</span>
      </div>
      
      <div class="btn-group">
        <button id="btn" class="btn" onclick="handleCheckIn()">ğŸ“ GPS æ‰“å¡</button>
        <button id="btn-wifi" class="btn btn-wifi" onclick="handleWifiCheckIn()">ğŸ“¡ Wi-Fi æ‰“å¡</button>
      </div>
      
      <button class="btn btn-mood" onclick="checkMood()">â˜€ï¸ æ¡‘å°¼ã®æ°—æŒã¡ã¯â‹¯ï¼Ÿ</button>
      
      <div class="footer-links">
        <button class="link-btn" onclick="openMakeupModal()">â° è£œæ‰“å¡ç”³è«‹</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="makeupModal">
    <div class="modal">
      <div class="res-title">è£œæ‰“å¡ç”³è«‹</div>
      <div class="input-group"><label>ç®¡ç†å¯†ç¢¼</label><input type="password" id="makeup-pass" placeholder="è¼¸å…¥å¯†ç¢¼"></div>
      <div class="input-group"><label>è£œå¡æ™‚é–“</label><input type="datetime-local" id="makeup-time"></div>
      <button class="btn" onclick="submitMakeup()">é€å‡ºç”³è«‹</button>
      <button class="btn close-btn" onclick="closeModal('makeupModal')">å–æ¶ˆ</button>
    </div>
  </div>

  <div class="modal-overlay" id="resultModal">
    <div class="modal" id="modalContent"></div>
  </div>

  <script>
    // âš ï¸ é€™è£¡çš„ ID å¦‚æœæ‚¨æœ‰åœ¨ GAS è¨­å®šå¥½ LIFF_IDï¼Œé€šå¸¸å¯ä»¥ç•™ç©º
    // ä½†å¦‚æœæœ‰éœ€è¦è·³è½‰ï¼Œå»ºè­°å¡«å…¥ä½ çš„ LIFF ID
    const LIFF_ID = ""; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbz_ZLQhmuDskyuOV4kdoW-LSpSMdt7eAtqMSAQbTQ34a-QMti4K0iSDQHX0dGxkR-Iq/exec"; 
    
    // åå–®è¨­å®š
    const USER_LIST = ["Eri", "Jessica","æ¸¬è©¦ç”¨"];

    const COMPANY_LAT = 25.06180836703763; 
    const COMPANY_LNG = 121.5446397637914;
    const ALLOWED_DISTANCE = 30; 
    
    let map, userMarker, companyCircle;
    let isFirstLocate = true; 
    let lastLat = 0; let lastLng = 0;

    const nameInput = document.getElementById('manual-name');
    const statusEl = document.getElementById('status');
    const btn = document.getElementById('btn');
    const btnWifi = document.getElementById('btn-wifi');
    const modalContent = document.getElementById('modalContent');

    window.onload = async function() {
      initDropdown();
      initMap();
      const savedName = localStorage.getItem('gps_uname');
      if (savedName && USER_LIST.includes(savedName)) nameInput.value = savedName;
      try { if(LIFF_ID) await liff.init({ liffId: LIFF_ID }); } catch (e) {}
    };

    function initMap() {
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([COMPANY_LAT, COMPANY_LNG], 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 20, subdomains: 'abcd' }).addTo(map);
        companyCircle = L.circle([COMPANY_LAT, COMPANY_LNG], { color: 'transparent', fillColor: '#0daaba', fillOpacity: 0.15, radius: ALLOWED_DISTANCE }).addTo(map);
        L.circleMarker([COMPANY_LAT, COMPANY_LNG], { radius: 4, color: '#fff', fillColor: '#0daaba', fillOpacity: 1, weight: 2 }).addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(
                (pos) => { updateMapLocation(pos.coords.latitude, pos.coords.longitude); checkDistanceRealtime(pos.coords.latitude, pos.coords.longitude); },
                (err) => { statusEl.innerText = "âŒ ç„¡æ³•å–å¾—ä½ç½®"; statusEl.style.color = "#ff5252"; },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }
    }

    function updateMapLocation(lat, lng) {
        if (getDistance(lat, lng, lastLat, lastLng) < 3 && !isFirstLocate) return; 
        lastLat = lat; lastLng = lng;
        if (userMarker) userMarker.setLatLng([lat, lng]);
        else {
            const pulseIcon = L.divIcon({ className: 'user-pulse-marker', iconSize: [16, 16], iconAnchor: [8, 8] });
            userMarker = L.marker([lat, lng], {icon: pulseIcon}).addTo(map);
        }
        if (isFirstLocate) { map.setView([lat, lng], 17, { animate: false }); isFirstLocate = false; }
    }

    function checkDistanceRealtime(lat, lng) {
       const dist = getDistance(lat, lng, COMPANY_LAT, COMPANY_LNG);
       if (dist <= ALLOWED_DISTANCE) { statusEl.innerHTML = `ğŸŸ¢ è·é›¢å…¬å¸ ${Math.round(dist)}m (å¯æ‰“å¡)`; statusEl.style.color = "#0daaba"; }
       else { statusEl.innerHTML = `ğŸ”´ è·é›¢å…¬å¸ ${Math.round(dist)}m (å¤ªé äº†)`; statusEl.style.color = "#ff5252"; }
    }

    // Wi-Fi æ‰“å¡é‚è¼¯
    async function handleWifiCheckIn() {
      const uname = nameInput.value.trim();
      if (!uname) return alert("è«‹é¸æ“‡å§“åï¼");
      localStorage.setItem('gps_uname', uname);
      
      btnWifi.disabled = true; 
      btnWifi.innerText = "é©—è­‰ä¸­...";

      try {
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipRes.json();
        const userIP = ipData.ip;
        
        submitData({ 
            action: 'check_in', 
            checkType: 'ip', 
            displayName: uname, 
            userIP: userIP,
            userLocation: "IPæª¢æŸ¥" 
        });

      } catch (e) {
        alert("ç„¡æ³•è®€å– IPï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸");
        btnWifi.disabled = false;
        btnWifi.innerText = "ğŸ“¡ Wi-Fi æ‰“å¡";
      }
    }

    function handleCheckIn() {
      const uname = nameInput.value.trim();
      if (!uname) return alert("è«‹é¸æ“‡å§“åï¼");
      localStorage.setItem('gps_uname', uname);
      if (!userMarker) return alert("æ­£åœ¨å®šä½ä¸­...è«‹ç¨ç­‰åœ°åœ–ç´…é»å‡ºç¾ğŸ“");
      
      const lat = userMarker.getLatLng().lat;
      const lng = userMarker.getLatLng().lng;
      
      btn.disabled = true; btn.innerText = "æ‰“å¡ä¸­...";
      
      const dist = getDistance(lat, lng, COMPANY_LAT, COMPANY_LNG);
      if (dist > ALLOWED_DISTANCE) { 
          showCheckInResult("âŒ æ‰“å¡å¤±æ•—", `ä¸åœ¨å…¬å¸ç¯„åœå…§\nè·é›¢å…¬å¸ ${Math.round(dist)}m`, -1); 
          resetBtn(); 
      } else { 
          submitData({ action: 'check_in', displayName: uname, userLocation: `${lat},${lng}` }); 
      }
    }

    function initDropdown() {
        USER_LIST.forEach(name => {
            let option = document.createElement("option"); option.value = name; option.text = name; nameInput.appendChild(option);
        });
    }

    async function checkMood() {
      const moodBtn = document.querySelector('.btn-mood'); const originalText = moodBtn.innerText;
      moodBtn.disabled = true; moodBtn.innerText = "è®€å–ä¸­...";
      try {
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_mood' }) });
        const json = await res.json();
        if (json.status === 'success') showMoodResult(json);
      } catch(e) { alert("é€£ç·šå¤±æ•—"); } finally { moodBtn.disabled = false; moodBtn.innerText = originalText; }
    }

    function openMakeupModal() { document.getElementById('makeupModal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function submitMakeup() {
      const uname = nameInput.value.trim(); if (!uname) return alert("è«‹å…ˆé¸æ“‡å§“å");
      const p = document.getElementById('makeup-pass').value; const t = document.getElementById('makeup-time').value;
      if (!p || !t) return alert("è«‹å¡«å¯«å®Œæ•´");
      closeModal('makeupModal');
      submitData({ action: 'check_in', displayName: uname, isMakeup: true, password: p, checkInTime: t, userLocation: "0,0" });
    }

    async function submitData(payload) {
      try {
        const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
        const json = await res.json();
        if (json.status === 'success') { 
           let msg = json.message; if (json.details) msg = `${json.details.status} (${json.details.time})\n${json.details.moodText}`;
           showCheckInResult("âœ… æ‰“å¡æˆåŠŸ", msg, json.score || 0);
        } else { showCheckInResult("âŒ å¤±æ•—", json.message, -1); }
      } catch (e) { alert("éŒ¯èª¤: " + e.toString()); } finally { resetBtn(); }
    }
    
    function resetBtn() { 
        btn.disabled = false; btn.innerText = "ğŸ“ GPS æ‰“å¡"; 
        btnWifi.disabled = false; btnWifi.innerText = "ğŸ“¡ Wi-Fi æ‰“å¡";
    }

    function showMoodResult(data) {
      let scoresHtml = '';
      if (data.scores) {
          const sorted = Object.keys(data.scores).sort((a,b) => data.scores[b] - data.scores[a]);
          sorted.forEach(u => {
             const c = data.scores[u] >= 0 ? '#06c755' : '#ff5252';
             scoresHtml += `<div class="score-row"><span style="color:#555">${u}</span><span style="font-weight:bold;color:${c}">${data.scores[u]}</span></div>`;
          });
      }
      modalContent.innerHTML = `<div class="mood-icon-wrapper" style="font-size:50px">${data.moodIcon}</div><div class="res-title">${data.moodText}</div><div style="color:#888;font-size:13px;margin-bottom:15px">"${data.flavorText}"</div><div class="score-list">${scoresHtml}</div><button class="btn close-btn" onclick="closeModal('resultModal')">é—œé–‰</button>`;
      document.getElementById('resultModal').style.display = 'flex';
      if (data.totalScore >= 50) fireConfetti();
    }
    function showCheckInResult(title, msg, score) {
      let icon = "ğŸ“‹"; if (score >= 50) { icon = "ğŸ«¢"; fireConfetti(); } else if (score > 0) icon = "ğŸ‘€"; else if (score < 0) icon = "ğŸ‘º";
      modalContent.innerHTML = `<div style="font-size:40px;margin-bottom:10px">${icon}</div><div class="res-title">${title}</div><div class="res-msg">${msg}</div><button class="btn" onclick="closeModal('resultModal')">å¥½çš„</button>`;
      document.getElementById('resultModal').style.display = 'flex';
    }
    function fireConfetti() { const c = ['#ff5252', '#0daaba', '#ffd700']; for (let i=0; i<40; i++) { const d=document.createElement('div'); d.classList.add('confetti'); d.style.left=Math.random()*100+'vw'; d.style.backgroundColor=c[Math.floor(Math.random()*c.length)]; d.style.animationDuration=(Math.random()*2+2)+'s'; document.body.appendChild(d); setTimeout(()=>d.remove(),4000); } }
    function getDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180; const a = Math.sin((lat2-lat1)*Math.PI/180/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin((lon2-lon1)*Math.PI/180/2)**2; return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
  </script>
</body>
</html>
